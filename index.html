<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Partiendo la sexta clase</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.js"></script>
        <style>
            body {
                color: #06122c;
            }
            em {
                font-style: normal;
                font-weight: bold;
                text-decoration: underline;
            }
            span {
                font-weight: bolder;
            }
            .ct-series-a .ct-line,
            .ct-series-a .ct-point {
                stroke: #8F2D56;
            }
        </style>
    </head>
    <body class="bg-light">
        <svg class="d-none" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <symbol id="pdf" viewBox="0 0 24 24">
                <path
                    fill-rule="evenodd"
                    clip-rule="evenodd"
                    d="M2 12C2 7.28595 2 4.92893 3.46447 3.46447C4.92893 2 7.28595 2 12 2C16.714 2 19.0711 2 20.5355 3.46447C22 4.92893 22 7.28595 22 12C22 16.714 22 19.0711 20.5355 20.5355C19.0711 22 16.714 22 12 22C7.28595 22 4.92893 22 3.46447 20.5355C2 19.0711 2 16.714 2 12ZM12 6.25C12.4142 6.25 12.75 6.58579 12.75 7V12.1893L14.4697 10.4697C14.7626 10.1768 15.2374 10.1768 15.5303 10.4697C15.8232 10.7626 15.8232 11.2374 15.5303 11.5303L12.5303 14.5303C12.3897 14.671 12.1989 14.75 12 14.75C11.8011 14.75 11.6103 14.671 11.4697 14.5303L8.46967 11.5303C8.17678 11.2374 8.17678 10.7626 8.46967 10.4697C8.76256 10.1768 9.23744 10.1768 9.53033 10.4697L11.25 12.1893V7C11.25 6.58579 11.5858 6.25 12 6.25ZM8 16.25C7.58579 16.25 7.25 16.5858 7.25 17C7.25 17.4142 7.58579 17.75 8 17.75H16C16.4142 17.75 16.75 17.4142 16.75 17C16.75 16.5858 16.4142 16.25 16 16.25H8Z"
                    fill="#1C274C"
                />
            </symbol>
        </svg>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <h1 class="ms-2 my-4"><span>diseño</span>uc</h1>
                    <p class="ms-2">
                        Memorias de Proyecto de Título con PDF disponible y en el ámbito de
                    </p>
                    <select class="ms-1">
                        <option value="Alimentación">Alimentación</option>
                        <option value="plicadas">Artesanía</option>
                        <option value="Bienestar">Bienestar</option>
                        <option value="Ciencia">Ciencia</option>
                        <option value="Ciudad">Ciudad</option>
                        <option value="Comunicación">Comunicación</option>
                        <option value="Cultura">Cultura</option>
                        <option value="Deporte">Deporte</option>
                        <option value="Educación">Educación</option>
                        <option value="Empresa">Empresa</option>
                        <option value="Entretenimiento">Entretenimiento</option>
                        <option value="Género">Género</option>
                        <option value="Inclusión">Inclusión</option>
                        <option value="Moda">Moda</option>
                        <option value="Salud">Salud</option>
                        <option value="Silvo-agropecuario">Silvo-agropecuario</option>
                        <option value="Sustentabilidad">Sustentabilidad</option>
                        <option value="Transporte">Transporte</option>
                        <option value="Turismo">Turismo</option>
                    </select>

                    <div class="card my-2 shadow-sm">
                        <div class="card-header">
                            <a>Notas promedio por profesor guía</a>
                        </div>
                        <div class="card-body">
                            <p>A continuación sólo se muestran las notas que están en o por sobre el promedio general de <span id="corte"></span></p>
                            <svg id="aqui"></svg>
                        </div>
                    </div>

                    <div class="card my-2 shadow-sm">
                        <div class="card-header">Palabras habituales en el ámbito</div>
                        <div class="card-body">
                            <p>
                                Ahora se reúnen todos los "para qué" de los proyectos en la tabla y se buscan en lo reunido las palabras repetidas tres o más veces (descartando artículos, adverbios, preposiciones y conjunciones).
                            </p>
                            <p id="palabreo"></p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card my-2 shadow-sm">
                        <div class="card-header">Memorias en el ámbito</div>
                        <div class="table-responsive">
                            <table class="table table-light table-hover small">
                                <thead class="table-danger">
                                    <tr>
                                        <th scope="col" class="text-center">#</th>
                                        <th scope="col" style="width: 20%;">Autor(a)</th>
                                        <th scope="col">Año</th>
                                        <th scope="col" style="width: 40%;">Título</th>
                                        <th scope="col">Ámbito</th>
                                        <th scope="col">Prof. Guía</th>
                                        <th scope="col" class="text-center">Nota</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="card my-2 shadow-sm">
                    <div class="card-header">Progresión de promedios generales de todos los proyectos de título</div>
                    <div class="card-body">
                        <!-- Los ct- son para dar la proporción visual del grafico en el viewport -->
                        <div class="ct-chart ct-double-octave"></div>
                    </div>
                </div>
            </div>
        </div>
        <script>
            const aqui = document.querySelector("tbody");
            const visualizacion = document.querySelector("#aqui");
            const palabreo = document.querySelector("#palabreo");

            async function datos(criterio) {
                var seleccion = [];
                var profes = [];
                var nombres = [];
                var barras = [];
                var ambitos = [];
                const consulta = await fetch("https://raw.githubusercontent.com/profesorfaco/dno097-2024/main/clase-06/data.json");
                const data = await consulta.json();
                console.log("Lo que sigue son todos los datos:");
                console.log(data);
                //Trabajando con 1400 elementos en el arreglo
                data.forEach((d) => {
                    d.nota_titulo = parseFloat(d.nota_titulo.replace(",", "."));
                    d.nota_pga = parseFloat(d.nota_pga.replace(",", "."));
                    d.nota_seminario = parseFloat(d.nota_seminario.replace(",", "."));
                    d.year = Number(d.year);
                    d.pdf_ok = Number(d.pdf_ok);
                    d.ambito = d.ambito.replace("Entrenimiento", "Entretenimiento");
                    if (d.ambito.includes(criterio) && d.pdf_ok == 1) {
                        seleccion.push(d);
                    } 
                    
                });
                console.log("Lo que sigue es una selección de los datos:");
                console.log(seleccion);
                //Trabajando con una selección
                seleccion.forEach((s, i) => {
                    if (6.4 < s.nota_titulo.toFixed(1)) {

                    aqui.innerHTML += `<tr><td class="text-center">${i + 1}</td><td>${s.nombre_paterno} ${s.nombre_materno}, ${s.nombre_pila[0]}.</td><td>${s.year}</td><td><a href="https://diseno.uc.cl/memorias/pdf/${
                        s.nombre_pdf
                    }" class="link-dark">${s.nombre_proyecto}</a> <svg width="1em" height="1em"><use href="#pdf"></use></svg></td><td>${s.ambito}</td><td>${s.nombre_guia}</td><td class="text-center">${s.nota_titulo.toFixed(1)}</td></tr>`;
                    }


                    let obj = {};
                    obj["prof"] = `${s.nombre_guia}`;
                    obj["nota"] = `${s.nota_titulo.toFixed(1)}`;
                    profes.push(obj);
                    nombres.push(s.nombre_guia);

                });
                /*
                    En el seleccion.forEach hice 3 cosas
                    1ra. llenar el tbody
                    2da. empujar objetos a la variable profes
                    3ra. empujar strings a la variable nombres
                */
                console.log("Lo que sigue son sólo los nombres, sin repetir:");
                nombres = [...new Set(nombres)].sort();
                console.log(nombres);
                //Basándome en nombres, trabajo con profes
                nombres.forEach((x) => {
                    //prof sin repetir
                    let unProf = profes.filter((p) => p.prof === x);
                    //promedio de notas de cada prof
                    let average = unProf.reduce((a, b) => a + Number(b.nota), 0) / unProf.length;
                    let obj = {};
                    obj["prof"] = x;
                    obj["promedio"] = Number(average);
                    barras.push(obj);
                });
                console.log("Lo que sigue son promedios para cada nombre:");
                console.log(barras);
                //Forma más "clásica" de sacar promedio
                var i = 0;
                var total = 0;
                barras.forEach((barra) => {
                    total += barra.promedio;
                    i++;
                });
                var corte = total / i;
                document.querySelector("#corte").innerHTML = corte.toFixed(2);
                var ajuste = 0;
                let mayor = 0;
                barras.forEach((x) => {
                    mayor = Math.max(mayor, x.promedio);
                    if (x.promedio >= corte) {
                        visualizacion.innerHTML += `<g transform="translate(0 ${ajuste * 3})"><rect x="0" y="0" height="2" width="70" fill="#eee"></rect><rect x="0" y="0" height="2" width="${
                            x.promedio.toFixed(1) * 10
                        }" fill="#8F2D56"></rect><text fill="white" font-size="1.2" x="0.5" y="1.4">${x.prof}</text><text fill="#06122c" font-size="1.2" x="${x.promedio.toFixed(1) * 10 - 2.5}" y="1.4">${x.promedio.toFixed(1)}</text></g>`;
                        ajuste++;
                    }
                });
                visualizacion.innerHTML += `<line x1="${mayor.toFixed(1) * 10}" y1="0" x2="${mayor.toFixed(1) * 10}" y2="${ajuste * 3}" stroke="white" stroke-width="0.1"/>`;
                var proporcion = "0 0 70 " + ajuste * 3;
                visualizacion.setAttribute("viewBox", proporcion);
                //Buscando las palabras frecuentes del "para qué" en su selección
                var words = "";
                seleccion.forEach((s) => (words = words + " " + s.para_que));
                var palabras = words.split(" ");
                palabras = palabras.sort();
                const nopalabras = [
                    "",
                    "a",
                    "al",
                    "así",
                    "como",
                    "con",
                    "de",
                    "De",
                    "del",
                    "dentro",
                    "desde",
                    "e",
                    "el",
                    "El",
                    "en",
                    "entre",
                    "esta",
                    "este",
                    "esto",
                    "estos",
                    "fin",
                    "hacia",
                    "la",
                    "las",
                    "le",
                    "les",
                    "lo",
                    "los",
                    "más",
                    "mediante",
                    "no",
                    "o",
                    "para",
                    "por",
                    "que",
                    "qué",
                    "se",
                    "sin",
                    "sobre",
                    "son",
                    "su",
                    "sus",
                    "tanto",
                    "través",
                    "un",
                    "una",
                    "unas",
                    "unos",
                    "vez",
                    "y",
                ];
                const sacaPalabras = (arreglo, sacar) => {
                    return arreglo.filter((palabra) => {
                        return !sacar.includes(palabra);
                    });
                };
                var palabrasAcotadas = sacaPalabras(palabras, nopalabras);
                const cuentaRepeticiones = (arreglo = []) => {
                    const resultado = [];
                    arreglo.forEach((el) => {
                        const index = resultado.findIndex((obj) => {
                            return obj["name"] === el;
                        });
                        if (index === -1) {
                            resultado.push({
                                name: el,
                                count: 1,
                            });
                        } else {
                            resultado[index]["count"]++;
                        }
                    });
                    return resultado;
                };
                var total = cuentaRepeticiones(palabrasAcotadas);
                total.forEach((x) => {
                    if (x.count >= 3) {
                        palabreo.innerHTML += `<span>${x.name} (${x.count})</span> `;
                    }
                });
            }

            datos("Alimentación").catch((error) => console.error(error));

            document.querySelector("select").addEventListener("change", (event) => {
                aqui.innerHTML = " ";
                visualizacion.innerHTML = " ";
                palabreo.innerHTML = " ";
                console.clear();
                var seleccion = [];
                var profes = [];
                var nombres = [];
                var barras = [];
                var ambitos = [];
                datos(event.target.value).catch((error) => console.error(error));
            });
        </script>
        <!-- En el siguiente script viene la estructura de cómo se debe poner un gráfico -->
        <script>
            new Chartist.Line(
                // lo que viene entre comillas es dónde yo quiero poner el gráfico.
                ".ct-chart",
                {
                    labels: [2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022],
                    series: [[6.24, 6.09, 5.86, 5.9, 5.95, 6.0, 6.04, 6.08, 6.13, 6.07, 6.11, 6.15, 6.15]],
                },
                {
                    axisY: {
                        offset: 30,
                    },
                }
            );
        </script>
    </body>
</html>

